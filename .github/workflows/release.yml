name: Release and Publish to NuGet

# This workflow publishes two packages:
# - StableDiffusionNet.Core (core library without DI)
# - StableDiffusionNet.DependencyInjection (DI extensions)

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v1.0.0, v2.1.3, etc.

env:
  DOTNET_VERSION: '8.0.x'
  CORE_PROJECT_PATH: 'StableDiffusionNet.Core/StableDiffusionNet.Core.csproj'
  DI_PROJECT_PATH: 'StableDiffusionNet.DependencyInjection/StableDiffusionNet.DependencyInjection.csproj'
  PACKAGE_OUTPUT_DIR: ${{ github.workspace }}/output

jobs:
  build-test-release:
    name: Build, Test, and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ GitVersion
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Get version from tag
      id: get_version
      run: |
        TAG=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$TAG" >> $GITHUB_OUTPUT
        echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "Version: $TAG"
    
    - name: Generate Release Notes
      id: release_notes
      run: |
        # Get previous tag
        PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # First release - all commits
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # Commits since last tag
          COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # Save to file
        if [ -z "$PREV_TAG" ]; then
          # First release
          cat << EOF > release_notes.md
        ## ðŸŽ‰ StableDiffusionNet ${{ steps.get_version.outputs.TAG_NAME }}
        
        ### ðŸ“¦ Installation
        
        **For usage without DI:**
        \`\`\`bash
        dotnet add package StableDiffusionNet.Core --version ${{ steps.get_version.outputs.VERSION }}
        \`\`\`
        
        **For usage with DI (ASP.NET Core):**
        \`\`\`bash
        dotnet add package StableDiffusionNet.DependencyInjection --version ${{ steps.get_version.outputs.VERSION }}
        \`\`\`
        
        ### âœ¨ Changes in this release
        
        ${COMMITS}
        
        ### ðŸ”— Useful links
        - [StableDiffusionNet.Core on NuGet](https://www.nuget.org/packages/StableDiffusionNet.Core/${{ steps.get_version.outputs.VERSION }})
        - [StableDiffusionNet.DependencyInjection on NuGet](https://www.nuget.org/packages/StableDiffusionNet.DependencyInjection/${{ steps.get_version.outputs.VERSION }})
        - [Documentation](https://github.com/${{ github.repository }}/blob/master/README.md)
        - [All releases](https://github.com/${{ github.repository }}/releases)
        EOF
        else
          # Subsequent releases
          cat << EOF > release_notes.md
        ## ðŸŽ‰ StableDiffusionNet ${{ steps.get_version.outputs.TAG_NAME }}
        
        ### ðŸ“¦ Installation
        
        **For usage without DI:**
        \`\`\`bash
        dotnet add package StableDiffusionNet.Core --version ${{ steps.get_version.outputs.VERSION }}
        \`\`\`
        
        **For usage with DI (ASP.NET Core):**
        \`\`\`bash
        dotnet add package StableDiffusionNet.DependencyInjection --version ${{ steps.get_version.outputs.VERSION }}
        \`\`\`
        
        ### âœ¨ Changes in this release
        
        ${COMMITS}
        
        ### ðŸ”— Useful links
        - [StableDiffusionNet.Core on NuGet](https://www.nuget.org/packages/StableDiffusionNet.Core/${{ steps.get_version.outputs.VERSION }})
        - [StableDiffusionNet.DependencyInjection on NuGet](https://www.nuget.org/packages/StableDiffusionNet.DependencyInjection/${{ steps.get_version.outputs.VERSION }})
        - [Documentation](https://github.com/${{ github.repository }}/blob/master/README.md)
        - [All releases](https://github.com/${{ github.repository }}/releases)
        
        ---
        **Full changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.get_version.outputs.TAG_NAME }}
        EOF
        fi
        
        echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: |
        dotnet build --configuration Release --no-restore \
          /p:Version=${{ steps.get_version.outputs.VERSION }}
    
    - name: Run unit tests
      run: dotnet test --configuration Release --no-build --verbosity minimal --filter "FullyQualifiedName!~Integration"
    
    - name: Pack NuGet packages
      run: |
        # Pack Core package
        dotnet pack ${{ env.CORE_PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --output ${{ env.PACKAGE_OUTPUT_DIR }} \
          /p:Version=${{ steps.get_version.outputs.VERSION }} \
          /p:PackageVersion=${{ steps.get_version.outputs.VERSION }}
        
        # Pack DependencyInjection package
        dotnet pack ${{ env.DI_PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --output ${{ env.PACKAGE_OUTPUT_DIR }} \
          /p:Version=${{ steps.get_version.outputs.VERSION }} \
          /p:PackageVersion=${{ steps.get_version.outputs.VERSION }}
    
    - name: List output files
      run: ls -la ${{ env.PACKAGE_OUTPUT_DIR }}
    
    - name: Create Release
      uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: Release ${{ steps.get_version.outputs.TAG_NAME }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg
          ${{ env.PACKAGE_OUTPUT_DIR }}/*.snupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Publish to NuGet
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg \
          --api-key "$NUGET_API_KEY" \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
    
    - name: Summary
      run: |
        echo "## âœ… Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ NuGet Packages:" >> $GITHUB_STEP_SUMMARY
        echo "- **Core:** https://www.nuget.org/packages/StableDiffusionNet.Core/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DependencyInjection:** https://www.nuget.org/packages/StableDiffusionNet.DependencyInjection/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY

